<!doctype html>
<script>
  async function init() {
    const worker = new Worker("worker.js");
    // Wait for worker + wasm to be ready
    await new Promise(resolve => worker.addEventListener("message", resolve, {once: true}));
    // Initialize encoder
    worker.postMessage([1, 30, 512, 512, 200 /*bitrate*/, false /*realtime*/]);

    const oc = new OffscreenCanvas(512, 512);
    const ctx = oc.getContext('2d');
    console.log('Generating...');
    for(let i = 0; i < 60; i++) {
      ctx.fillStyle = 'red';
      ctx.fillRect(0, 0, 512, 512);
      ctx.fillStyle = 'blue';
      ctx.fillRect(i, i, 10, 10);
      const {data} = ctx.getImageData(0, 0, 512, 512);
      worker.postMessage(data.buffer, [data.buffer]);
    }
    // Signal end-of-stream
    worker.postMessage(null);
    // Wait for webm file
    const result = await new Promise(resolve => {
      worker.addEventListener("message", ev => resolve(ev.data), {once: true});
    });
    const blobUrl = URL.createObjectURL(new Blob([result], {type: "video/webm"}));
    console.log('Done');
    console.log(`Total file size: ${result.byteLength}`);
    worker.terminate();
    document.body.innerHTML = `<video src="${blobUrl}" autoplay loop muted controls></video>`;
  }
  init();
</script>
