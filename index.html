<!doctype html>

<script src="encoder.js"></script>
<script>
Module.onRuntimeInitialized = async () => {
  const oc = new OffscreenCanvas(512, 512);
  const ctx = oc.getContext('2d');
  const encoder = new Module.WebmEncoder(1, 30, 512, 512, 200);
  if(encoder.lastError()) {
    console.error(encoder.lastError());
    return;
  }
  console.log('Generating...');
  for(let i = 0; i < 60; i++) {
    ctx.fillStyle = 'red';
    ctx.fillRect(0, 0, 512, 512);
    ctx.fillStyle = 'blue';
    ctx.fillRect(i, i, 10, 10);
    const data = ctx.getImageData(0, 0, 512, 512);
    if(!encoder.addRGBAFrame(data.data)) {
      console.log(`Frame ${i} failed`);
    }
  }
  console.log('Done');
  const data = encoder.finalize();
  const blob = URL.createObjectURL(new Blob([data]));
  encoder.delete();
  document.body.innerHTML = `<video src="${blob}" autoplay loop muted controls></video>`;
}
</script>
